<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - Digital Credit CRM</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  
  <div class="login-page">
    <div class="login-card">
      
      <!-- Logo -->
      <div class="login-logo">
        <img src="assets/logo.png" alt="Digital Credit" style="max-height: 120px; margin-bottom: 12px;">
        <div class="login-logo-sub">CRM — Noleggio a Lungo Termine</div>
      </div>
      
      <!-- Titolo -->
      <h1 class="login-title">Accedi al tuo account</h1>
      
      <!-- Errore login -->
      <div class="login-error" id="login-error">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
        <span id="login-error-text">Credenziali non valide</span>
      </div>
      
      <!-- Form login -->
      <div id="login-form">
        
        <!-- Username -->
        <div class="form-group">
          <label class="form-label" for="input-username">Username</label>
          <div class="input-icon-wrapper">
            <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            <input 
              type="text" 
              id="input-username" 
              class="form-input" 
              placeholder="Inserisci username"
              autocomplete="username"
              autofocus
            >
          </div>
        </div>
        
        <!-- Password -->
        <div class="form-group">
          <label class="form-label" for="input-password">Password</label>
          <div class="input-icon-wrapper">
            <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
            <input 
              type="password" 
              id="input-password" 
              class="form-input" 
              placeholder="Inserisci password"
              autocomplete="current-password"
              style="padding-right: 44px;"
            >
            <button type="button" class="input-toggle-password" id="btn-toggle-password" title="Mostra/nascondi password">
              <svg id="icon-eye" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
              <svg id="icon-eye-off" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none;"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
            </button>
          </div>
        </div>
        
        <!-- Bottone accedi -->
        <button class="btn btn-primary login-btn" id="btn-login">
          <span id="btn-login-text">Accedi</span>
          <div id="btn-login-spinner" style="display:none;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="animation: spin 0.7s linear infinite;"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
          </div>
        </button>
        
      </div>
      
      <!-- Footer -->
      <div class="login-footer">
        &copy; 2025 Digital Credit — Tutti i diritti riservati
      </div>
      
    </div>
  </div>
  
  <!-- Firebase SDK (CDN compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
  
  <!-- Script progetto -->
  <script src="js/firebase-config.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/auth.js"></script>
  
  <script>
    // ============================================
    // Logica pagina Login
    // ============================================
    
    // Se già loggato, vai alla dashboard
    (function() {
      var utente = getUtenteCorrente();
      if (utente) {
        window.location.href = 'dashboard.html';
        return;
      }
    })();
    
    // Riferimenti DOM
    var inputUsername = document.getElementById('input-username');
    var inputPassword = document.getElementById('input-password');
    var btnLogin = document.getElementById('btn-login');
    var btnLoginText = document.getElementById('btn-login-text');
    var btnLoginSpinner = document.getElementById('btn-login-spinner');
    var loginError = document.getElementById('login-error');
    var loginErrorText = document.getElementById('login-error-text');
    var btnTogglePassword = document.getElementById('btn-toggle-password');
    var iconEye = document.getElementById('icon-eye');
    var iconEyeOff = document.getElementById('icon-eye-off');
    
    // Toggle mostra/nascondi password
    btnTogglePassword.addEventListener('click', function() {
      var isPassword = inputPassword.type === 'password';
      inputPassword.type = isPassword ? 'text' : 'password';
      iconEye.style.display = isPassword ? 'none' : 'block';
      iconEyeOff.style.display = isPassword ? 'block' : 'none';
    });
    
    // Mostra errore
    function mostraErroreLogin(messaggio) {
      loginErrorText.textContent = messaggio;
      loginError.classList.add('visible');
    }
    
    // Nascondi errore
    function nascondiErroreLogin() {
      loginError.classList.remove('visible');
    }
    
    // Stato loading del bottone
    function setLoading(loading) {
      btnLogin.disabled = loading;
      btnLoginText.style.display = loading ? 'none' : 'inline';
      btnLoginSpinner.style.display = loading ? 'inline-flex' : 'none';
    }
    
    // Funzione di login
    async function eseguiLogin() {
      nascondiErroreLogin();
      
      var username = inputUsername.value.trim();
      var password = inputPassword.value;
      
      // Validazione base
      if (!username) {
        mostraErroreLogin('Inserisci il tuo username');
        inputUsername.focus();
        return;
      }
      
      if (!password) {
        mostraErroreLogin('Inserisci la password');
        inputPassword.focus();
        return;
      }
      
      // Avvia login
      setLoading(true);
      
      var risultato = await login(username, password);
      
      if (risultato.successo) {
        // Login riuscito → vai alla dashboard
        mostraToast('Benvenuto, ' + risultato.utente.nomeCompleto + '!', 'success');
        setTimeout(function() {
          window.location.href = 'dashboard.html';
        }, 500);
      } else {
        // Login fallito
        setLoading(false);
        mostraErroreLogin(risultato.errore);
        inputPassword.value = '';
        inputPassword.focus();
      }
    }
    
    // Click sul bottone
    btnLogin.addEventListener('click', eseguiLogin);
    
    // Invio con Enter
    inputUsername.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        inputPassword.focus();
      }
    });
    
    inputPassword.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        eseguiLogin();
      }
    });
    
    // Nascondi errore quando si digita
    inputUsername.addEventListener('input', nascondiErroreLogin);
    inputPassword.addEventListener('input', nascondiErroreLogin);
    
    console.log('✅ Pagina login caricata');
  </script>
  
</body>
</html>
